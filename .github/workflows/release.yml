name: Release offline bundle

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.label }} bundle
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            label: macos-arm64
            package_os: macos
          - os: windows-latest
            label: windows-x64
            package_os: windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build portable zip
        env:
          PACKAGE_LABEL: ${{ matrix.label }}
          PACKAGE_OS: ${{ matrix.package_os }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PYTHON_BIN=python
          ROOT_DIR="${GITHUB_WORKSPACE}"
          BUILD_DIR="${ROOT_DIR}/_bundle"
          VENV_DIR="${ROOT_DIR}/_bundle_env"
          ARTIFACT_DIR="${ROOT_DIR}/artifacts"

          RAW_REF_NAME="${GITHUB_REF_NAME:-}"
          if [ -n "${RAW_REF_NAME}" ]; then
            VERSION_TAG="${RAW_REF_NAME}"
          else
            VERSION_TAG="v0.0.0-dev"
          fi
          case "${VERSION_TAG}" in
            v*) ;;
            *) VERSION_TAG="v${VERSION_TAG}" ;;
          esac
          VERSION_NUMBER="${VERSION_TAG#v}"

          PACKAGE_NAME="gip-vision-offline-usb-${PACKAGE_OS}-${VERSION_TAG}"
          export PACKAGE_NAME
          PKG_DIR="${BUILD_DIR}/${PACKAGE_NAME}"

          rm -rf "$BUILD_DIR" "$ARTIFACT_DIR" "$VENV_DIR"
          mkdir -p "$PKG_DIR" "$PKG_DIR/config" "$ARTIFACT_DIR"

          ${PYTHON_BIN} -m venv "$VENV_DIR"

          if [ -f "$VENV_DIR/bin/python" ]; then
            ENV_PY="$VENV_DIR/bin/python"
          else
            ENV_PY="$VENV_DIR/Scripts/python.exe"
          fi

          "$ENV_PY" -m pip install --upgrade pip
          "$ENV_PY" -m pip install --no-cache-dir -r config/requirements.txt

          "$ENV_PY" - <<'PY'
          import fastapi
          import ifcopenshell
          import numpy
          import pxr
          import pygltflib
          import trimesh
          import uvicorn

          del fastapi, ifcopenshell, numpy, pxr, pygltflib, trimesh, uvicorn

          print("[offline-bundle] dependencies import ok")
          PY

          cp -a app "$PKG_DIR/"
          cp -a config/requirements.txt "$PKG_DIR/config/requirements.txt"
          cp -a README.txt "$PKG_DIR/"
          cp -a "$VENV_DIR" "$PKG_DIR/config/.offline_env"

          {
            echo "tag: ${VERSION_TAG}"
            echo "version: ${VERSION_NUMBER}"
            echo "built_at_utc: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo "commit: ${GITHUB_SHA:-unknown}"
            echo "repository: fesworkscience/gip-vision-offline-usb"
            echo "releases_url: https://github.com/fesworkscience/gip-vision-offline-usb/releases"
          } > "$PKG_DIR/config/version.yaml"

          if [ "${PACKAGE_LABEL}" = "macos-arm64" ]; then
            cp -a start.py start.command "$PKG_DIR/"
            chmod +x "$PKG_DIR/start.command"

            PYBS_URL=""
            for candidate in \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20260211/cpython-3.11.14+20260211-aarch64-apple-darwin-install_only_stripped.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20260211/cpython-3.11.14+20260211-aarch64-apple-darwin-install_only.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20260107/cpython-3.11.14+20260107-aarch64-apple-darwin-install_only_stripped.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20260107/cpython-3.11.14+20260107-aarch64-apple-darwin-install_only.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251217/cpython-3.11.14+20251217-aarch64-apple-darwin-install_only_stripped.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251217/cpython-3.11.14+20251217-aarch64-apple-darwin-install_only.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251120/cpython-3.11.14+20251120-aarch64-apple-darwin-install_only_stripped.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251120/cpython-3.11.14+20251120-aarch64-apple-darwin-install_only.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251010/cpython-3.11.14+20251010-aarch64-apple-darwin-install_only_stripped.tar.gz" \
              "https://github.com/astral-sh/python-build-standalone/releases/download/20251010/cpython-3.11.14+20251010-aarch64-apple-darwin-install_only.tar.gz"
            do
              if curl --fail --silent --show-error --location \
                --connect-timeout 8 \
                --max-time 120 \
                --retry 1 \
                --retry-all-errors \
                --retry-delay 1 \
                "$candidate" -o "$ARTIFACT_DIR/python-standalone.tar.gz"; then
                PYBS_URL="$candidate"
                break
              fi
            done

            if [ -z "${PYBS_URL}" ]; then
              echo "[offline-bundle] Failed to download a known python-build-standalone asset"
              exit 1
            fi
            echo "[offline-bundle] Using portable Python: $PYBS_URL"
            mkdir -p "$PKG_DIR/config/.offline_python"
            tar -xzf "$ARTIFACT_DIR/python-standalone.tar.gz" -C "$PKG_DIR/config/.offline_python" --strip-components=1

            PORTABLE_PY="$PKG_DIR/config/.offline_python/bin/python3.11"
            if [ ! -x "$PORTABLE_PY" ]; then
              PORTABLE_PY="$PKG_DIR/config/.offline_python/bin/python3"
            fi
            if [ ! -x "$PORTABLE_PY" ]; then
              echo "[offline-bundle] Portable Python binary not found after extraction"
              exit 1
            fi

            PYTHONHOME="$PKG_DIR/config/.offline_python" \
            PYTHONPATH="$PKG_DIR/config/.offline_env/lib/python3.11/site-packages" \
            "$PORTABLE_PY" - <<'PY'
          import ssl
          import _socket
          import fastapi
          import ifcopenshell
          import pxr
          import uvicorn
          print("[offline-bundle] macOS standalone runtime import ok")
          PY
          else
            cp -a run.bat "$PKG_DIR/"
          fi

          mkdir -p "$PKG_DIR/config/workspace/jobs"

          # Reduce size a bit. Keep only files needed for runtime.
          find "$PKG_DIR/config/.offline_env" -type d -name "__pycache__" -prune -exec rm -rf {} +
          find "$PKG_DIR/config/.offline_env" -type d -name "pip-wheel-metadata" -prune -exec rm -rf {} +
          find "$PKG_DIR/config/.offline_env" -type f -name "*.pyc" -delete
          find "$PKG_DIR/app" -type d -name "__pycache__" -prune -exec rm -rf {} +
          find "$PKG_DIR/app" -type f -name "*.pyc" -delete
          rm -rf "$PKG_DIR/tests" "$PKG_DIR/app/tests"

          if [ -d "$PKG_DIR/tests" ] || [ -d "$PKG_DIR/app/tests" ]; then
            echo "[offline-bundle] tests directory leaked into release package"
            exit 1
          fi

          if find "$PKG_DIR/app" -type f -name "test_*.py" -print -quit | grep -q .; then
            echo "[offline-bundle] test files leaked into release package"
            exit 1
          fi

          # Create one zip per OS
          python - <<'PY'
          import os
          import shutil
          from pathlib import Path

          build_dir = Path("_bundle")
          package_name = os.environ["PACKAGE_NAME"]
          archive = Path("artifacts") / package_name
          shutil.make_archive(
              str(archive),
              "zip",
              root_dir=str(build_dir),
              base_dir=package_name,
          )
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gip-vision-offline-usb-${{ matrix.package_os }}-${{ github.ref_name }}
          path: artifacts/*.zip
          retention-days: 30

  publish-release:
    name: Publish GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          merge-multiple: true

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: all-artifacts/*
          generate_release_notes: true
          make_latest: latest
